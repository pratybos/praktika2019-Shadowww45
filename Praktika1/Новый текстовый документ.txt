#include "pch.h"
#include <iostream>
#include <iomanip>
#include <fstream>
#include <cstdlib>
#include <windows.h>
#include <conio.h>

using namespace std;

const char CDfv[] = "Monsters.txt";
const char CDfr[] = "Map.txt";

char MAP[999][999];

struct Monsters
{
	char Name[20];
	int Damage;
	int HP;
}m[5];

void SetColor(int value)
{
	SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), value);
}

void gotoXY(int x, int y)
{
	HANDLE console = GetStdHandle(STD_OUTPUT_HANDLE); // used for goto
	COORD CursorPosition;
	CursorPosition.X = x;
	CursorPosition.Y = y;
	SetConsoleCursorPosition(console, CursorPosition);
}

void Enemies(struct Monsters m[])
{
	ifstream fd(CDfv);
	int n;
	fd >> n;
	cin >> m[0].Name;
	m[0].Damage = 3;
	m[0].HP = 20;
	for (int i = 1; i <= n; i++) {
		fd >> m[i].Name >> m[i].HP >> m[i].Damage;
	}
}

void MAPSuk()
{
	ifstream fd(CDfr);
	for (int i = 1; i < 50; i++) {
		for (int j = 1; j < 79; j++) {
			fd >> MAP[i][j];
		}
	}
}

void Items(struct Monsters m[])
{

}

void Fight(int b, struct Monsters m[])
{
	system("cls");
	int Hp = m[b].HP;
	gotoXY(18, 5); cout << "You"; gotoXY(25, 5); cout << " VS " << m[b].Name << endl;
	gotoXY(18, 6); cout << "Your HP: " << m[0].HP << "    " << "Enemie HP: " << m[b].HP << endl;
	gotoXY(18, 7); cout << "Your Damage: " << m[0].Damage << "    " << "Enemie Damege: " << m[b].Damage << endl;

}

void Icon(struct Monsters m[])
{
		int a = rand() % 10 + 1;
		if (a > 8) {
			int b = rand() % 3 + 1;
			//cout << m[b].Name;
			Fight(b,m);
		}
}

void MAPSpau(COORD c)
{
	for (int i = 1; i <= 40; i++) {
		for (int j = 1; j <= 78; j++) {
			if (MAP[i][j] != '|' || MAP[i][j] != '=') {
				if (c.Y == i && c.X == j) {
					MAP[i + 1][j + 1] = char('X');
				}
			}
			cout << MAP[i][j];
		}cout << endl;
	}
}

void MAP_Ejimas(COORD c)
{
	for (int i = 1; i <= 40; i++) {
		for (int j = 1; j <= 78; j++) {
				if (c.Y == i && c.X == j) {
					MAP[c.Y+1][c.X+1] = char('o');
				}
			//cout << MAP[i][j];
		}//cout << endl;
	}
}

void Menu()
{
	int menu = 0, x = 7;
	gotoXY(18, 5); cout << "Main Menu";
	gotoXY(18, 7); cout << "->";
	while (true)
	{
		gotoXY(20, 7);  cout << "Start";
		gotoXY(20, 8);  cout << "Leaderboard";
		gotoXY(20, 9); cout << "Exit";
		system("pause>nul"); // the >nul bit causes it the print no message
		if (GetAsyncKeyState(VK_DOWN) && x != 9) //down button pressed
		{
			gotoXY(18, x); cout << "  ";
			x++;
			gotoXY(18, x); cout << "->";
			menu++;
			continue;
		}
		if (GetAsyncKeyState(VK_UP) && x != 7) //up button pressed
		{
			gotoXY(18, x); cout << "  ";
			x--;
			gotoXY(18, x); cout << "->";
			menu--;
			continue;
		}
		if (GetAsyncKeyState(VK_RETURN)) { // Enter key pressed
			switch (menu) {
			case 0: {//Start
				return;
				break;
			}
			case 1: {//Leaderboard
				/*gotoXY(20, 16);*/
				system("cls");
				break;
			}
			case 2: {//Exit
				exit(0);
			}
			}
		}
	}
}

int main()
{
	Menu();
	system("cls");
	SetColor(7);
	/*int l;
	HANDLE h = GetStdHandle(STD_OUTPUT_HANDLE);
	COORD c = { 30, 30 };
	switch (l)
	{
	case 72:
	}*/
	Monsters m[6];
	Enemies(m);
	cout <<m[0].Name<< "Enter your Nickname: ";
	cout << m[0].Name;
	system("cls");
	MAPSuk();
	/*for (int i = 1; i <= 40; i++){
		for (int j = 1; j <= 60; j++) {
			cout << "0";
		}cout << endl;
	}system("cls");
	for (int i = 1; i <= 50; i++) {
		for (int j = 1; j <= 100; j++) {
			cout << "o";
		}cout << endl;
	}
	system("cls");
	Monsters m[4];
	Enemies(m);*/
	//cout << m[3].HP - 6;
	SetColor(7);
	/*Your favorite pausing goes here*/
	MAPSpau({ 30,30 });
	HANDLE h = GetStdHandle(STD_OUTPUT_HANDLE);
	COORD c = { 30, 30 };
	SetConsoleCursorPosition(h, c);
  	while (1)
	{
			int k = _getch();
			if (k == 0 || k == 224)  k = _getch();
			switch (k)
			{
			case 72: //72,75,77,80 - код для клавиш стрелок на клавиатуре
				if (c.Y > 1){
					system("cls");
					MAP_Ejimas(c);
					c.Y--;
					MAPSpau(c);
					if (c.Y > 6) {
						Icon(m);
					}
				}
				break;
			case 75:
				if (c.X > 1) {
					system("cls");
					MAP_Ejimas(c);
					c.X--;
					MAPSpau(c);
					if (c.X > 8) {
						Icon(m);
					}
				}
				break;
			case 77:
				if (c.X < 76) {
					system("cls");
					MAP_Ejimas(c);
					c.X++;
					MAPSpau(c);
					Icon(m);
				}
				break;
			case 80:
				if (c.Y < 38) {
					system("cls");
					MAP_Ejimas(c);
					c.Y++;
					MAPSpau(c);
					Icon(m);
				}
				break;
			case 27:
				system("cls");
				Menu();
				break;
			default: return 0;;
			}
			SetConsoleCursorPosition(h, c);
	}
	return 0;
}